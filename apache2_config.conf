# Конфигурация Apache2 для Seeker
# Этот файл будет автоматически настроен скриптом установки
# Домен и пути берутся из .env файла

<VirtualHost *:80>
    ServerName DOMAIN_PLACEHOLDER
    ServerAlias www.DOMAIN_PLACEHOLDER
    DocumentRoot SEEKER_PATH_PLACEHOLDER

    # Временно разрешаем HTTP доступ для получения SSL сертификата
    # После получения SSL сертификата certbot добавит редирект автоматически

    # Настройка прокси для Python приложения
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyVia Off

    # Статические файлы и шаблоны обслуживаются напрямую Apache
    <LocationMatch "^/(template|css|js|images|fonts|php)/">
        ProxyPass !
    </LocationMatch>

    # PHP файлы обслуживаются Apache
    <FilesMatch "\.php$">
        SetHandler application/x-httpd-php
        ProxyPass !
    </FilesMatch>

    # Основные эндпоинты Python приложения (специфичные пути должны быть первыми)
    ProxyPass /location http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/location
    ProxyPassReverse /location http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/location

    ProxyPass /info http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/info
    ProxyPassReverse /info http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/info

    # Проксируем остальные запросы к Python приложению (общий путь должен быть последним)
    ProxyPass / http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/
    ProxyPassReverse / http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/

    # Конфигурация для статических файлов
    <Directory "SEEKER_PATH_PLACEHOLDER">
        Options -Indexes
        AllowOverride All
        Require all granted

        # Обработка PHP файлов
        <FilesMatch "\.php$">
            SetHandler application/x-httpd-php
        </FilesMatch>
    </Directory>

    # Конфигурация для шаблонов
    <Directory "SEEKER_PATH_PLACEHOLDER/template">
        Options -Indexes
        AllowOverride All
        Require all granted
    </Directory>

    # Конфигурация для PHP файлов
    <Directory "SEEKER_PATH_PLACEHOLDER/php">
        Options -Indexes
        AllowOverride All
        Require all granted

        <FilesMatch "\.php$">
            SetHandler application/x-httpd-php
        </FilesMatch>
    </Directory>

    # Конфигурация для логов (запрет доступа)
    <Directory "SEEKER_PATH_PLACEHOLDER/logs">
        Require all denied
    </Directory>

    # Конфигурация для базы данных (запрет доступа)
    <Directory "SEEKER_PATH_PLACEHOLDER/db">
        Require all denied
    </Directory>

    # Конфигурация для виртуального окружения (запрет доступа)
    <Directory "SEEKER_PATH_PLACEHOLDER/venv">
        Require all denied
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/DOMAIN_PLACEHOLDER_error.log
    CustomLog ${APACHE_LOG_DIR}/DOMAIN_PLACEHOLDER_access.log combined
</VirtualHost>

# SSL VirtualHost будет создан автоматически certbot'ом
# <VirtualHost *:443>
#     ServerName DOMAIN_PLACEHOLDER
#     ServerAlias www.DOMAIN_PLACEHOLDER
#     DocumentRoot SEEKER_PATH_PLACEHOLDER
#
#     # SSL Configuration (настраивается certbot)
#     SSLEngine on

#     # Настройка прокси для Python приложения
#     ProxyPreserveHost On
#     ProxyRequests Off
#     ProxyVia Off
#
#     # Статические файлы и шаблоны обслуживаются напрямую Apache
#     <LocationMatch "^/(template|css|js|images|fonts|php)/">
#         ProxyPass !
#     </LocationMatch>
#
#     # PHP файлы обслуживаются Apache
#     <FilesMatch "\.php$">
#         SetHandler application/x-httpd-php
#         ProxyPass !
#     </FilesMatch>
#
#     # Основные эндпоинты Python приложения (специфичные пути должны быть первыми)
#     ProxyPass /location http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/location
#     ProxyPassReverse /location http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/location
#
#     ProxyPass /info http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/info
#     ProxyPassReverse /info http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/info
#
#     # Проксируем остальные запросы к Python приложению (общий путь должен быть последним)
#     ProxyPass / http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/
#     ProxyPassReverse / http://127.0.0.1:SEEKER_PORT_PLACEHOLDER/
#
#     # Конфигурация для статических файлов
#     <Directory "SEEKER_PATH_PLACEHOLDER">
#         Options -Indexes
#         AllowOverride All
#         Require all granted
#
#         # Обработка PHP файлов
#         <FilesMatch "\.php$">
#             SetHandler application/x-httpd-php
#         </FilesMatch>
#     </Directory>
#
#     # Конфигурация для шаблонов
#     <Directory "SEEKER_PATH_PLACEHOLDER/template">
#         Options -Indexes
#         AllowOverride All
#         Require all granted
#     </Directory>
#
#     # Конфигурация для PHP файлов
#     <Directory "SEEKER_PATH_PLACEHOLDER/php">
#         Options -Indexes
#         AllowOverride All
#         Require all granted
#
#         <FilesMatch "\.php$">
#             SetHandler application/x-httpd-php
#         </FilesMatch>
#     </Directory>
#
#     # Конфигурация для логов (запрет доступа)
#     <Directory "SEEKER_PATH_PLACEHOLDER/logs">
#         Require all denied
#     </Directory>
#
#     # Конфигурация для базы данных (запрет доступа)
#     <Directory "SEEKER_PATH_PLACEHOLDER/db">
#         Require all denied
#     </Directory>
#
#     # Конфигурация для виртуального окружения (запрет доступа)
#     <Directory "SEEKER_PATH_PLACEHOLDER/venv">
#         Require all denied
#     </Directory>
#
#     # Заголовки безопасности
#     Header always set X-Frame-Options "SAMEORIGIN"
#     Header always set X-Content-Type-Options "nosniff"
#     Header always set X-XSS-Protection "1; mode=block"
#     Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#     Header always set Referrer-Policy "strict-origin-when-cross-origin"
#     Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self';"
#
#     # Кэширование статических файлов
#     <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
#         ExpiresActive On
#         ExpiresDefault "access plus 1 month"
#         Header append Cache-Control "public"
#     </LocationMatch>
#
#     # Сжатие
#     <LocationMatch "\.(css|js|html|xml|txt|json)$">
#         SetOutputFilter DEFLATE
#     </LocationMatch>
#
#     # Логирование
#     ErrorLog ${APACHE_LOG_DIR}/DOMAIN_PLACEHOLDER_ssl_error.log
#     CustomLog ${APACHE_LOG_DIR}/DOMAIN_PLACEHOLDER_ssl_access.log combined
#
#     # Дополнительное логирование для отладки
#     LogLevel info ssl:warn
# </VirtualHost>

# Дополнительные настройки безопасности
<IfModule mod_headers.c>
    # Убираем информацию о сервере
    Header unset Server
    Header always unset X-Powered-By
    Header unset X-Powered-By
</IfModule>

<IfModule mod_security2.c>
    # Базовые правила ModSecurity (если установлен)
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess Off
    SecResponseBodyMimeType text/plain text/html text/xml
    SecDataDir /tmp/
</IfModule>
